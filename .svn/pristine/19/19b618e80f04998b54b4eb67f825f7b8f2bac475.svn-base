<?php

namespace App\Http\Controllers\Master;

use App\Addon;
use App\Consume;
use App\Line;
use App\Linetwo;
use App\Order;
use App\OrderProduct;
use App\User;
use Carbon\Carbon;
use Illuminate\Http\Request;
use App\Http\Controllers\Controller;
use Illuminate\Support\Facades\Validator;

class ListController extends Controller
{
    private  $allstatus;

    public function __construct(){
        $this->allstatus = [
            '未审核',
            '已审核待入库',
            '已拣货待打包',
            '已入库代付款',
            '已付款待出库',
            '已出库',
            '已发往起运机场',
            '飞往中国',
            '抵达海关，等候清关',
            '海关清关中',
            '已出关转国内派送',
            '已签收',
            99=>'异常件'
        ];
    }

    public function index($status){
        $output['status'] = $status;
        $output['allstatus'] = $this->allstatus;
        $output['line'] = Line::select(['id','name'])->orderBy('order','DESC')->orderBy('created_at','DESC')->get();
        return view('master.list.index',$output);
    }

    public function getData($status,Request $request){
        $page = intval($request->post('page',10));
        $limit = intval($request->post('limit',10));

        $data = Order::whereRaw('1 = 1');
        if ($status > 0) $data = $data->where('status',$status-1);
        $acceptParams = ['system_order_no','s_name','r_name','r_phone','user_order_no','line_id','r_cre_num_status','id_card_thumb_status','start','end','status'];
        foreach ($acceptParams as $val){
            if (!empty($request->get($val))){
                if ($val == 'start'){
                    $data = $data->where('created_at','>=',$request->get($val));
                }elseif ($val == 'end'){
                    $data = $data->where('created_at','<=',$request->get($val));
                }elseif ($val == 'r_cre_num_status'){
                    $data = $request->get($val) == 1 ? $data->whereNotNull('r_cre_num') : $data->whereNull('r_cre_num');
                }elseif ($val == 'id_card_thumb_status'){
                    $data = $request->get($val) == 1 ? $data->whereNotNull('id_card_front')->whereNotNull('id_card_back') : $data->whereNull('id_card_front')->whereNull('id_card_back');
                }elseif ($val == 'system_order_no'){
                    $system_order_no = explode("\n",$request->get($val));
                    if (count($system_order_no) == 1){
                        $data = $data->where('system_order_no','like','%'.$system_order_no[0].'%');
                    }else{
                        $data = $data->whereIn('system_order_no',$system_order_no);
                    }
                }else{
                    if (is_int($request->get($val))){
                        $data = $data->where($val,$request->get($val));
                    }else{
                        $data = $data->where($val,'like','%'.$request->get($val).'%');
                    }
                }
            }
        }
        $count = $data->count();
        $outputData = $data->offset(($page-1)*$limit)->limit($limit)->orderBy('created_at','DESC')->get();
        foreach ($outputData as $key=>$val){
            $val['number'] = $key+1;
            $val['statustr'] = $this->allstatus[$val['status']];
            $outputData[$key] = $val;
        }
        return response()->json(['status'=>200,'msg'=>'Success','data'=>$outputData,'count'=>$count]);
    }

    public function showAudit(Request $request){
        $line_id = intval($request->get('line_id'));
        $line = Line::select(['linetwos'])->where('id',$line_id)->first();
        $linetwos = explode(',',$line->linetwos);
        $linetwoInfo = Linetwo::whereIn('id',$linetwos)->orderBy('order','DESC')->orderBy('created_at','DESC')->get();
        return view('master.list.audit',['linetwoInfo'=>$linetwoInfo]);
    }
    public function audit(Request $request){
        $post = $request->post();
        $post['statusJson'] = json_decode($post['statusJson'],true);
        return $this->__checkStatusChange($post,1);
    }
    public function pick(Request $request){
        return $this->__checkStatusChange($request->post(),2);
    }
    public function showWeight(){ return view('master.list.weight'); }
    public function weight(Request $request){
        $post = $request->post();
        $info = Order::where('system_order_no',$post['system_order_no'])->first();
        if (!isset($info) || empty($info)) return response()->json(['status'=>-100,'msg'=>'订单不存在']);
        $post['statusJson'][] = '{"id":'.$info->id.',"status":'.$info->status.'}';
        return $this->__checkStatusChange($post,3);
    }
    public function charge(Request $request){
        return $this->__countCharge($request->post(),4);
    }
    public function getout(Request $request){
        return $this->__checkStatusChange($request->post(),5);
    }
    public function showChange(){ return view('master.list.change',['allstatus'=>$this->allstatus]); }
    public function change(Request $request){
        $post = $request->post();
        $post['statusJson'] = json_decode($post['statusJson'],true);
        return $this->__checkStatusChange($post, intval($request->post('status')));
    }

    public function productDetail($system_order_no){
        $system_order_no = strip_tags(trim($system_order_no));
        $data = OrderProduct::where('system_order_no',$system_order_no)->get();
        return view('master.list.productDetail',['data'=>$data]);
    }

    private function __checkStatusChange($request,$changeStatus){
        $validator = Validator::make($request,['statusJson' => 'required|array','weight' => 'nullable|numeric', 'tax' => 'nullable|numeric', 'fail_reason' => 'nullable|string|max:255', 'express_no'=>'nullable|string|max:50', 'linetwo'=>'nullable|integer']);
        $statusArray = ['未审核','审核','拣货','称重','扣款','出库'];
        if ($validator->fails()) return json_encode(['status'=>-100,'msg'=>'保存失败']);
        foreach ($request['statusJson'] as $val){
            if (!is_array($val)) $val = json_decode($val,true);
            if ($changeStatus < $val['status'] && $val['status'] <> 99) return json_encode(['status'=>-101,'msg'=>'抱歉，订单不允许回退操作']);
            if ($changeStatus <= 5 && $val['status']+1 <> $changeStatus) return json_encode(['status'=>-102,'msg'=>'抱歉，该订单还未进行'.$statusArray[$val['status']+1].'操作']);
            if (isset($request['weight']) && $request['weight'] > 0) $update['weight'] = number_format($request['weight'],2,'.','');
            if (isset($request['tax']) && $request['tax'] > 0) $update['tax'] = number_format($request['tax'],2,'.','');
            if (isset($request['fail_reason'])) $update['fail_reason'] = $request['fail_reason'];
            if (isset($request['express_no'])) $update['express_no'] = $request['express_no'];
            if (isset($request['linetwo'])) $update['linetwo'] = $request['linetwo'];
            $update['before_status'] = $val['status'];
            $update['status'] = $changeStatus;
            Order::where('id',$val['id'])->update($update);
        }
        return json_encode(['status'=>200,'msg'=>'保存成功']);
    }

    private function __countCharge($request,$changeStatus){
        $validator = Validator::make($request,['statusJson' => 'required|array']);
        if ($validator->fails()) return json_encode(['status'=>-100,'msg'=>'保存失败']);
        foreach ($request['statusJson'] as $val){
            $val = json_decode($val,true);
            if ($changeStatus < $val['status']) return json_encode(['status'=>-101,'msg'=>'抱歉，订单不允许回退操作']);

            $sum = 0;
            $info = Order::find($val['id']);
            $lineData = $info->lineData;
            $userData = $info->userData;
            $price = json_decode($lineData->price,true);
            $addons = Addon::whereIn('name',explode(',',$info->addons))->get();
            $overweight = json_decode($lineData->overweight,true)[$userData->rank];
            //初始价格（根据会员等级）
            $sum += $price[$userData->rank];
            //附加费用
            foreach ($addons as $addonval){
                $sum += $addonval['money'];
            }
            //超重后的额外费用（根据会员等级）
            if ($info->weight > $lineData->ykg){
                $yushu = $info->weight - $lineData->ykg;
                switch ($lineData->rule){
                    case 1:
                        $sum += ceil($yushu / $lineData->goon) * $overweight['price'];
                        break;
                    case 3:
                        $zhengshu = floor($yushu / $lineData->goon);
                        $tuiwei = number_format($yushu - $zhengshu * $lineData->goon,2,',','') >= $lineData->outon ? $overweight['price'] : 0;
                        $sum += $zhengshu * $overweight['price'] + $tuiwei;
                        break;
                    default:
                        $sum += ($yushu / $lineData->goon) * $overweight['price'];
                        break;
                }
            }
            $sum = number_format($sum,2,'.','');
            //检查用余额
            if ($userData->money < $sum){
                return json_encode(['status'=>-101,'msg'=>'用户余额不足']);
            }else{
                $consume = [
                    'uid'=>$userData->id,
                    'name'=>$userData->name,
                    'consume_order_no'=> 'C'.date('YmdHis').mt_rand(100000,999999),
                    'system_order_no'=>$info->system_order_no,
                    'user_order_no'=>$info->user_order_no,
                    'money'=>$sum,
                ];
                Consume::create($consume);
                $leftMoney = number_format(($userData->money - $sum),2,'.','');
                User::where('id',$info->uid)->update(['money'=>$leftMoney]);
            }

            $update['money'] = $sum;
            $update['before_status'] = $val['status'];
            $update['status'] = $changeStatus;
            Order::where('id',$val['id'])->update($update);
        }
        return json_encode(['status'=>200,'msg'=>'操作成功']);
    }
}
