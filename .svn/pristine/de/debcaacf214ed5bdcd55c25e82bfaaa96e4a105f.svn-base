<?php

namespace App\Http\Controllers\Index;

use App\User;
use Illuminate\Http\Request;
use App\Http\Controllers\Controller;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Facades\Mail;

class RegisterController extends Controller
{
    private $output,$trans,$user;

    public function __construct(){
        $pathArray = explode('/',url()->current());
        $step =  strtolower($pathArray[4]);
        $this->trans = ['one'=>1,'two'=>2,'three'=>3,'four'=>4,'five'=>5,'six'=>6];
        $this->output['nowStep'] = $this->trans[$step];
        $this->output['titles'] = ["填写注册信息","验证注册邮箱","完善个人信息","上传证件","签署授权","等待确认"];
        $this->output['type'] = $pathArray[5];
    }

    public function stepOne(){
        if ($jump = $this->__checkStep()) return redirect($jump);
        return view('index.register1',$this->output);
    }

    public function postStepOne(Request $request){
        $this->validate($request,[
            'name' => 'bail|required||max:20|unique:users',
            'password' => 'bail|required|between:6,20',
            'password_confirmation' => 'bail|required|same:password',
            'email' => 'bail|required|email|unique:users',
            'xing' => 'bail|required|max:10',
            'ming' => 'bail|required|max:10',
            'verifycode' => 'bail|required|captcha',
        ]);

        $insert['name'] = strip_tags(trim($request->post('name','')));
        $insert['type'] = $this->output['type'];
        $insert['password'] = Hash::make(strip_tags(trim($request->post('password',''))));
        $insert['email'] = strip_tags(trim($request->post('email','')));
        $insert['xing'] = strip_tags(trim($request->post('xing','')));
        $insert['ming'] = strip_tags(trim($request->post('ming','')));

        $user = User::create($insert);
        if ($user){
            Auth::login($user,true);
            return response()->json(['status'=>200,'msg'=>'注册成功']);
        }else{
            return response()->json(['status'=>-100,'msg'=>'注册失败，请联系管理员']);
        }
    }

    public function stepTwo(){
        if ($jump = $this->__checkStep()) return redirect($jump);
        return view('index.register2',$this->output);
    }

    public function postStepTwo(Request $request){
        $this->validate($request,[
            'emailverifycode'=>'required||max:10'
        ]);
        $emailverifycode = strip_tags(trim($request->post('emailverifycode','')));
        $sessionCode = $request->session()->get('email-verifycode','');
        if ($emailverifycode == $sessionCode){
            User::where('id',Auth::id())->update(['step'=>$this->output['nowStep']+1]);
            return response()->json(['status'=>200,'msg'=>'验证成功']);
        }else{
            return response()->json(['status'=>-100,'msg'=>'邮箱验证码错误或者失效，请重新获取']);
        }
    }

    public function stepThree(){
        if ($jump = $this->__checkStep()) return redirect($jump);
        return view('index.register3',$this->output);
    }

    public function stepFour(){
        if ($jump = $this->__checkStep()) return redirect($jump);
        return view('index.register4',$this->output);
    }

    public function stepFive(){
        if ($jump = $this->__checkStep()) return redirect($jump);
        return view('index.register5',$this->output);
    }

    public function stepSix(){
        if ($jump = $this->__checkStep()) return redirect($jump);
        return view('index.register6',$this->output);
    }

    public function sendEmail(Request $request){
        $this->user = Auth::user();
        if($this->user->step == 2){
            $rand = mt_rand(10000,99999);
            $request->session()->flash('email-verifycode', $rand);
            Mail::raw('恭喜您注册成功，验证码：'.$rand , function ($message){
                $user = Auth::user();
                $message->subject('美和国际物流');
                $message->to($this->user->email);
            });
        }
        return response()->json(['status'=>200,'msg'=>'发送成功']);
    }

    public function __checkStep(){
        if (Auth::check()){
            $user = Auth::user();
            $toStep = array_search($user->step,$this->trans);
            if ($user->step > $this->output['nowStep']) return '/register/'.$toStep.'/'.$this->output['type'];
        }
    }
}
