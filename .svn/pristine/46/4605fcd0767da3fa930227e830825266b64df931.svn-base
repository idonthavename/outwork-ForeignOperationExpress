<?php

namespace App\Http\Controllers\Master;

use App\Order;
use Carbon\Carbon;
use Illuminate\Http\Request;
use App\Http\Controllers\Controller;

class ListController extends Controller
{

    public function index($status){
        return view('master.list.index',['status'=>$status]);
    }

    public function getData($status,Request $request){
        $page = intval($request->post('page',10));
        $limit = intval($request->post('limit',10));

        $data = Order::whereRaw('1 = 1');
        if ($status > 0) $data = $data->where('status',$status-1);
        $acceptParams = ['system_order_no','s_name','r_name','r_phone','user_order_no','line_id','r_cre_num_status','id_card_thumb_status','start','end','iscare'];
        foreach ($acceptParams as $val){
            if (!empty($request->get($val))){
                if ($val == 'start'){
                    $data = $data->where('created_at','>=',$request->get($val));
                }elseif ($val == 'end'){
                    $data = $data->where('created_at','<=',$request->get($val));
                }elseif ($val == 'r_cre_num_status'){
                    $data = $request->get($val) == 1 ? $data->whereNotNull('r_cre_num') : $data->whereNull('r_cre_num');
                }elseif ($val == 'id_card_thumb_status'){
                    $data = $request->get($val) == 1 ? $data->whereNotNull('id_card_front')->whereNotNull('id_card_back') : $data->whereNull('id_card_front')->whereNull('id_card_back');
                }else{
                    $data = $data->where($val,$request->get($val));
                }
            }
        }
        $count = $data->count();
        $outputData = $data->offset(($page-1)*$limit)->limit($limit)->orderBy('created_at','DESC')->get();
        foreach ($outputData as $key=>$val){
            $val['number'] = $key+1;
            $outputData[$key] = $val;
        }
        return response()->json(['status'=>200,'msg'=>'Success','data'=>$outputData,'count'=>$count]);
    }
}
